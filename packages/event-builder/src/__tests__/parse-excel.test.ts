import * as XLSX from "xlsx";
import { PackSpecificationId } from "@nhsdigital/nhs-notify-event-schemas-supplier-config/src/domain/pack-specification";
import { tmpdir } from "node:os";
import path from "node:path";
import { parseExcelFile } from "../lib/parse-excel";

function buildWorkbook(data: {
  packs: any[];
  variants: any[];
  volumeGroups?: any[];
  suppliers?: any[];
  allocations?: any[];
  supplierPacks?: any[];
}) {
  const wb = XLSX.utils.book_new();
  const packSheet = XLSX.utils.json_to_sheet(data.packs);
  const variantSheet = XLSX.utils.json_to_sheet(data.variants);
  XLSX.utils.book_append_sheet(wb, packSheet, "PackSpecification");
  XLSX.utils.book_append_sheet(wb, variantSheet, "LetterVariant");

  // Add required new sheets with defaults if not provided
  const volumeGroupSheet = XLSX.utils.json_to_sheet(data.volumeGroups || []);
  XLSX.utils.book_append_sheet(wb, volumeGroupSheet, "VolumeGroup");

  const supplierSheet = XLSX.utils.json_to_sheet(data.suppliers || []);
  XLSX.utils.book_append_sheet(wb, supplierSheet, "Supplier");

  const allocationSheet = XLSX.utils.json_to_sheet(data.allocations || []);
  XLSX.utils.book_append_sheet(wb, allocationSheet, "SupplierAllocation");

  const supplierPackSheet = XLSX.utils.json_to_sheet(data.supplierPacks || []);
  XLSX.utils.book_append_sheet(wb, supplierPackSheet, "SupplierPack");

  return wb;
}

// Replace individual missing sheet tests with table-driven tests
function buildWorkbookOmitting(omit: string): XLSX.WorkBook {
  const wb = XLSX.utils.book_new();
  const packSheet = XLSX.utils.json_to_sheet([
    {
      id: "pack-1",
      name: "Pack 1",
      status: "PUBLISHED",
      version: "1",
      createdAt: "2024-01-01",
      updatedAt: "2024-01-01",
      "postage.id": "postage-1",
      "postage.size": "STANDARD",
    },
  ]);
  if (omit !== "PackSpecification") {
    XLSX.utils.book_append_sheet(wb, packSheet, "PackSpecification");
  }
  if (omit !== "LetterVariant") {
    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet([]),
      "LetterVariant",
    );
  }
  if (omit !== "VolumeGroup") {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([]), "VolumeGroup");
  }
  if (omit !== "Supplier") {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([]), "Supplier");
  }
  if (omit !== "SupplierAllocation") {
    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet([]),
      "SupplierAllocation",
    );
  }
  if (omit !== "SupplierPack") {
    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet([]),
      "SupplierPack",
    );
  }
  return wb;
}

function writeWorkbook(wb: XLSX.WorkBook): string {
  const filePath = path.join(tmpdir(), `test-${Date.now()}.xlsx`);
  XLSX.writeFile(wb, filePath);
  return filePath;
}

describe("parse-excel", () => {
  it("parses canonical enum values", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-1",
          name: "Pack 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-standard",
          "postage.size": "STANDARD",
        },
        {
          id: "pack-2",
          name: "Pack 2",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-large",
          "postage.size": "LARGE",
        },
      ],
      variants: [
        {
          id: "variant-1",
          name: "Variant 1",
          description: "Variant 1",
          volumeGroupId: "volume-group-1",
          packSpecificationIds: "pack-1,pack-2",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.pack1.postage.id).toBe("postage-standard");
    expect(result.packs.pack1.postage.size).toBe("STANDARD");
    expect(result.packs.pack2.postage.id).toBe("postage-large");
    expect(result.packs.pack2.postage.size).toBe("LARGE");
    expect(result.variants.variant1.packSpecificationIds).toEqual([
      PackSpecificationId("pack-1"),
      PackSpecificationId("pack-2"),
    ]);
  });

  it("throws on invalid postage size", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-bad-size",
          name: "Bad Size Pack",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-bad",
          "postage.size": "C5", // invalid size value
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Validation failed.*pack-bad-size/,
    );
  });

  it("throws on missing required postage fields", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-missing",
          name: "Missing Pack",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          // missing postage fields entirely
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Missing required postage fields/,
    );
  });

  it("parses constraints on PackSpecification", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-with-constraints",
          name: "Pack with Constraints",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "constraints.maxSheets": "10",
          "constraints.deliverySLA": "5",
          "constraints.blackCoveragePercentage": "80.5",
          "constraints.colourCoveragePercentage": "50.25",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packwithconstraints.constraints).toEqual({
      maxSheets: 10,
      deliverySLA: 5,
      blackCoveragePercentage: 80.5,
      colourCoveragePercentage: 50.25,
    });
  });

  it("parses constraints on LetterVariant", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-1",
          name: "Pack 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-with-constraints",
          name: "Variant with Constraints",
          description: "Test variant",
          volumeGroupId: "volume-group-1",
          packSpecificationIds: "pack-1",
          type: "STANDARD",
          status: "PUBLISHED",
          "constraints.maxSheets": "8",
          "constraints.deliverySLA": "3",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.variants.variantwithconstraints.constraints).toEqual({
      maxSheets: 8,
      deliverySLA: 3,
    });
  });

  it("parses assembly with paper, insertIds, and features", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-with-assembly",
          name: "Pack with Assembly",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.envelopeId": "envelope-1",
          "assembly.printColour": "COLOUR",
          "assembly.paper.id": "paper-1",
          "assembly.paper.name": "Standard White",
          "assembly.paper.weightGSM": "90",
          "assembly.paper.size": "A4",
          "assembly.paper.colour": "WHITE",
          "assembly.paper.recycled": "true",
          "assembly.insertIds": "insert-1,insert-2",
          "assembly.features": "MAILMARK,BRAILLE",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    const pack = result.packs.packwithassembly;
    expect(pack.assembly?.envelopeId).toBe("envelope-1");
    expect(pack.assembly?.printColour).toBe("COLOUR");
    expect(pack.assembly?.paper?.id).toBe("paper-1");
    expect(pack.assembly?.paper?.name).toBe("Standard White");
    expect(pack.assembly?.paper?.weightGSM).toBe(90);
    expect(pack.assembly?.paper?.size).toBe("A4");
    expect(pack.assembly?.paper?.colour).toBe("WHITE");
    expect(pack.assembly?.paper?.recycled).toBe(true);
    expect(pack.assembly?.insertIds).toEqual(["insert-1", "insert-2"]);
    expect(pack.assembly?.features).toEqual(["MAILMARK", "BRAILLE"]);
  });

  it("thows when LetterVariant sheet is missing", () => {
    const wb = XLSX.utils.book_new();
    const packSheet = XLSX.utils.json_to_sheet([
      {
        id: "pack-1",
        name: "Pack 1",
        status: "PUBLISHED",
        version: "1",
        createdAt: "2024-01-01",
        updatedAt: "2024-01-01",
        "postage.id": "postage-standard",
        "postage.size": "STANDARD",
      },
    ]);
    XLSX.utils.book_append_sheet(wb, packSheet, "PackSpecification");
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /LetterVariant sheet not found in Excel file/,
    );
  });

  it("thows when PackSpecification sheet is missing", () => {
    const wb = XLSX.utils.book_new();
    const variantSheet = XLSX.utils.json_to_sheet([
      {
        id: "variant-1",
        name: "Variant 1",
        description: "Variant 1",
        packSpecificationIds: "pack-1,pack-2",
        type: "STANDARD",
        status: "PUBLISHED",
      },
    ]);
    XLSX.utils.book_append_sheet(wb, variantSheet, "LetterVariant");
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /PackSpecification sheet not found in Excel file/,
    );
  });

  it("throws if LetterVariant type is invalid", () => {
    const wb = XLSX.utils.book_new();
    const variantSheet = XLSX.utils.json_to_sheet([
      {
        id: "variant-1",
        name: "Variant 1",
        description: "Variant 1",
        packSpecificationIds: "pack-1",
        type: "INVALID_TYPE",
        status: "PUBLISHED",
      },
    ]);
    XLSX.utils.book_append_sheet(wb, variantSheet, "LetterVariant");
    const packSheet = XLSX.utils.json_to_sheet([
      {
        id: "pack-1",
        name: "Pack 1",
        status: "PUBLISHED",
        version: "1",
        createdAt: "2024-01-01",
        updatedAt: "2024-01-01",
        "postage.id": "postage-standard",
        "postage.size": "STANDARD",
      },
    ]);
    XLSX.utils.book_append_sheet(wb, packSheet, "PackSpecification");
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(/Validation failed.*variant-1/);
  });

  it("parses optional billingId field", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-with-billing",
          name: "Pack with Billing",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          billingId: "billing-123",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packwithbilling.billingId).toBe("billing-123");
  });

  it("parses optional postage fields", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-full-postage",
          name: "Pack with Full Postage",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "LARGE",
          "postage.deliverySLA": "2",
          "postage.maxWeight": "100.5",
          "postage.maxThickness": "5.2",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    const { postage } = result.packs.packfullpostage;
    expect(postage.deliverySLA).toBe(2);
    expect(postage.maxWeight).toBe(100.5);
    expect(postage.maxThickness).toBe(5.2);
  });

  it("handles missing createdAt/updatedAt with default dates", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-no-dates",
          name: "Pack No Dates",
          status: "PUBLISHED",
          version: "1",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packnodates.createdAt).toBe("2023-01-01T00:00:00Z");
    expect(result.packs.packnodates.updatedAt).toBe("2023-01-01T00:00:00Z");
  });

  it("handles invalid date strings with default date", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-invalid-dates",
          name: "Pack Invalid Dates",
          status: "PUBLISHED",
          version: "1",
          createdAt: "not-a-date",
          updatedAt: "also-not-a-date",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packinvaliddates.createdAt).toBe(
      "2023-01-01T00:00:00Z",
    );
    expect(result.packs.packinvaliddates.updatedAt).toBe(
      "2023-01-01T00:00:00Z",
    );
  });

  it("handles empty string arrays as undefined", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-empty-arrays",
          name: "Pack Empty Arrays",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.insertIds": "",
          "assembly.features": "  ",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packemptyarrays.assembly?.insertIds).toBeUndefined();
    expect(result.packs.packemptyarrays.assembly?.features).toBeUndefined();
  });

  it("parses assembly.additional as JSON", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-with-additional",
          name: "Pack with Additional",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.additional": '{"key1":"value1","key2":"value2"}',
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packwithadditional.assembly?.additional).toEqual({
      key1: "value1",
      key2: "value2",
    });
  });

  it("ignores invalid JSON in assembly.additional", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-bad-json",
          name: "Pack Bad JSON",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.additional": "not-valid-json{",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packbadjson.assembly?.additional).toBeUndefined();
  });

  it("parses paper.recycled as boolean", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-recycled-true",
          name: "Pack Recycled True",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.paper.id": "paper-1",
          "assembly.paper.name": "Recycled Paper",
          "assembly.paper.size": "A4",
          "assembly.paper.colour": "WHITE",
          "assembly.paper.recycled": "TRUE",
        },
        {
          id: "pack-recycled-false",
          name: "Pack Recycled False",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-2",
          "postage.size": "LARGE",
          "assembly.paper.id": "paper-2",
          "assembly.paper.name": "Non-Recycled Paper",
          "assembly.paper.size": "A3",
          "assembly.paper.colour": "COLOURED",
          "assembly.paper.recycled": "false",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packrecycledtrue.assembly?.paper?.recycled).toBe(true);
    expect(result.packs.packrecycledfalse.assembly?.paper?.recycled).toBe(
      false,
    );
  });

  it("uses default weightGSM when not provided", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-default-gsm",
          name: "Pack Default GSM",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.paper.id": "paper-1",
          "assembly.paper.size": "A4",
          "assembly.paper.colour": "WHITE",
          "assembly.paper.recycled": "false",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packdefaultgsm.assembly?.paper?.weightGSM).toBe(80);
  });

  it("parses LetterVariant with optional clientId and campaignIds", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-1",
          name: "Pack 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-with-ids",
          name: "Variant with IDs",
          description: "Test variant",
          volumeGroupId: "volume-group-1",
          packSpecificationIds: "pack-1",
          type: "STANDARD",
          status: "PUBLISHED",
          clientId: "client-123",
          campaignIds: "campaign-1,campaign-2,campaign-3",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.variants.variantwithids.clientId).toBe("client-123");
    expect(result.variants.variantwithids.campaignIds).toEqual([
      "campaign-1",
      "campaign-2",
      "campaign-3",
    ]);
  });

  it("uses name as description when description is missing", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-1",
          name: "Pack 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-no-desc",
          name: "My Variant Name",
          volumeGroupId: "volume-group-1",
          packSpecificationIds: "pack-1",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.variants.variantnodesc.description).toBe("My Variant Name");
  });

  it("throws on empty packSpecificationIds", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-1",
          name: "Pack 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-no-packs",
          name: "Variant No Packs",
          description: "Test",
          packSpecificationIds: "",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Validation failed.*variant-no-packs/,
    );
  });

  it("sanitizes IDs by removing non-alphanumeric characters", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-with-dashes-123",
          name: "Pack with Dashes",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant_with_underscores_456",
          name: "Variant with Underscores",
          volumeGroupId: "volume-group-1",
          packSpecificationIds: "pack-with-dashes-123",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packwithdashes123).toBeDefined();
    expect(result.variants.variantwithunderscores456).toBeDefined();
  });

  it("handles partial constraints - only maxSheets", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-partial-1",
          name: "Pack Partial 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "constraints.maxSheets": "15",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packpartial1.constraints).toEqual({
      maxSheets: 15,
    });
  });

  it("handles partial constraints - only deliverySLA", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-partial-2",
          name: "Pack Partial 2",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "constraints.deliverySLA": "7",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packpartial2.constraints).toEqual({
      deliverySLA: 7,
    });
  });

  it("handles partial constraints - only coverage percentages", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-partial-3",
          name: "Pack Partial 3",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "constraints.blackCoveragePercentage": "90.5",
          "constraints.colourCoveragePercentage": "60.25",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packpartial3.constraints).toEqual({
      blackCoveragePercentage: 90.5,
      colourCoveragePercentage: 60.25,
    });
  });

  it("parses assembly with only envelopeId", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-envelope-only",
          name: "Pack Envelope Only",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.envelopeId": "envelope-123",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packenvelopeonly.assembly).toEqual({
      envelopeId: "envelope-123",
    });
  });

  it("parses assembly with only printColour", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-print-only",
          name: "Pack Print Only",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.printColour": "BLACK",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packprintonly.assembly).toEqual({
      printColour: "BLACK",
    });
  });

  it("throws when postage.id is missing but postage.size is present", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-missing-id",
          name: "Pack Missing ID",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Missing required postage fields.*pack-missing-id/,
    );
  });

  it("throws when postage.size is missing but postage.id is present", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-missing-size",
          name: "Pack Missing Size",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Missing required postage fields.*pack-missing-size/,
    );
  });

  it("handles all assembly fields together", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-full-assembly",
          name: "Pack Full Assembly",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.envelopeId": "env-1",
          "assembly.printColour": "COLOUR",
          "assembly.paper.id": "paper-1",
          "assembly.paper.name": "Premium",
          "assembly.paper.weightGSM": "100",
          "assembly.paper.size": "A3",
          "assembly.paper.colour": "COLOURED",
          "assembly.paper.recycled": "true",
          "assembly.insertIds": "insert-a,insert-b",
          "assembly.features": "MAILMARK,AUDIO,ADMAIL",
          "assembly.additional": '{"note":"test"}',
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    const { assembly } = result.packs.packfullassembly;
    expect(assembly?.envelopeId).toBe("env-1");
    expect(assembly?.printColour).toBe("COLOUR");
    expect(assembly?.paper?.id).toBe("paper-1");
    expect(assembly?.insertIds).toEqual(["insert-a", "insert-b"]);
    expect(assembly?.features).toEqual(["MAILMARK", "AUDIO", "ADMAIL"]);
    expect(assembly?.additional).toEqual({ note: "test" });
  });

  it("parses arrays with whitespace correctly", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-whitespace-arrays",
          name: "Pack Whitespace Arrays",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.insertIds": " insert-1 , insert-2 , insert-3 ",
          "assembly.features": " MAILMARK , BRAILLE ",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packwhitespacearrays.assembly?.insertIds).toEqual([
      "insert-1",
      "insert-2",
      "insert-3",
    ]);
    expect(result.packs.packwhitespacearrays.assembly?.features).toEqual([
      "MAILMARK",
      "BRAILLE",
    ]);
  });

  it("handles empty insertIds but valid features", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-empty-inserts",
          name: "Pack Empty Inserts",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.insertIds": "  ",
          "assembly.features": "MAILMARK",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packemptyinserts.assembly?.insertIds).toBeUndefined();
    expect(result.packs.packemptyinserts.assembly?.features).toEqual([
      "MAILMARK",
    ]);
  });

  it("handles valid insertIds but empty features", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-empty-features",
          name: "Pack Empty Features",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2024-01-01",
          updatedAt: "2024-01-01",
          "postage.id": "postage-1",
          "postage.size": "STANDARD",
          "assembly.insertIds": "insert-1",
          "assembly.features": "  ",
        },
      ],
      variants: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packemptyfeatures.assembly?.insertIds).toEqual([
      "insert-1",
    ]);
    expect(result.packs.packemptyfeatures.assembly?.features).toBeUndefined();
  });

  const missingSheetCases: { sheet: string; error: RegExp }[] = [
    { sheet: "VolumeGroup", error: /VolumeGroup sheet not found/ },
    { sheet: "Supplier", error: /Supplier sheet not found/ },
    {
      sheet: "SupplierAllocation",
      error: /SupplierAllocation sheet not found/,
    },
    { sheet: "SupplierPack", error: /SupplierPack sheet not found/ },
  ];

  for (const { error, sheet } of missingSheetCases) {
    it(`throws when ${sheet} sheet is missing (table-driven)`, () => {
      const wb = buildWorkbookOmitting(sheet);
      // Ensure we are only consolidating the four; PackSpecification & LetterVariant already tested separately.
      const file = writeWorkbook(wb);
      expect(() => parseExcelFile(file)).toThrow(error);
    });
  }

  it("parses VolumeGroup with description and endDate", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-x",
          name: "Pack X",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-02",
          "postage.id": "postage-x",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-x",
          name: "Variant X",
          volumeGroupId: "volume-group-x",
          packSpecificationIds: "pack-x",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
      volumeGroups: [
        {
          id: "volume-group-x",
          name: "VolumeGroup X",
          description: "My VolumeGroup",
          startDate: "2025-01-01",
          endDate: "2025-12-31",
          status: "PUBLISHED",
        },
      ],
      suppliers: [],
      allocations: [],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.volumeGroups.volumegroupx.description).toBe("My VolumeGroup");
    expect(result.volumeGroups.volumegroupx.endDate).toBe("2025-12-31");
    expect(result.volumeGroups.volumegroupx.startDate).toBe("2025-01-01");
    expect(result.volumeGroups.volumegroupx.status).toBe("PUBLISHED");
  });

  it("parses Suppliers of all channel types", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-y",
          name: "Pack Y",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-y",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [],
      suppliers: [
        { id: "supplier-app", name: "App Supplier", channelType: "NHSAPP", dailyCapacity: "1000" },
        { id: "supplier-sms", name: "SMS Supplier", channelType: "SMS", dailyCapacity: "2000" },
        { id: "supplier-email", name: "Email Supplier", channelType: "EMAIL", dailyCapacity: "3000" },
        {
          id: "supplier-letter",
          name: "Letter Supplier",
          channelType: "LETTER",
          dailyCapacity: "4000",
        },
      ],
      allocations: [],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.suppliers.supplierapp.channelType).toBe("NHSAPP");
    expect(result.suppliers.suppliersms.channelType).toBe("SMS");
    expect(result.suppliers.supplieremail.channelType).toBe("EMAIL");
    expect(result.suppliers.supplierletter.channelType).toBe("LETTER");
  });

  it("throws on invalid Supplier channelType", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-z",
          name: "Pack Z",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-z",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [],
      suppliers: [
        { id: "supplier-bad", name: "Bad Supplier", channelType: "PIGEON", dailyCapacity: "1000" },
      ],
      allocations: [],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Validation failed.*supplier-bad/,
    );
  });

  it("parses SupplierAllocations including boundary percentages and sanitizes IDs", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-a",
          name: "Pack A",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-a",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [
        { id: "volume-group-a", name: "VolumeGroup A", startDate: "2025-01-01" },
      ],
      suppliers: [
        { id: "supplier-a", name: "Supplier A", channelType: "LETTER", dailyCapacity: "1000" },
        { id: "supplier-b", name: "Supplier B", channelType: "LETTER", dailyCapacity: "2000" },
        { id: "supplier-c", name: "Supplier C", channelType: "LETTER", dailyCapacity: "3000" },
      ],
      allocations: [
        {
          id: "allocation-1%", // sanitized
          volumeGroupId: "volume-group-a",
          supplier: "supplier-a",
          allocationPercentage: "0",
          status: "PUBLISHED",
        },
        {
          id: "allocation-2%",
          volumeGroupId: "volume-group-a",
          supplier: "supplier-b",
          allocationPercentage: "75",
          status: "PUBLISHED",
        },
        {
          id: "allocation-3%",
          volumeGroupId: "volume-group-a",
          supplier: "supplier-c",
          allocationPercentage: "100",
          status: "PUBLISHED",
        },
      ],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.allocations.allocation1.volumeGroup).toBe("volume-group-a");
    expect(result.allocations.allocation2.allocationPercentage).toBe(75);
    expect(result.allocations.allocation3.allocationPercentage).toBe(100);
  });

  it("throws when allocationPercentage is out of bounds (<0 or >100)", () => {
    const wbHigh = buildWorkbook({
      packs: [
        {
          id: "pack-bounds",
          name: "Pack Bounds",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-bounds",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [
        {
          id: "volume-group-bounds",
          name: "VolumeGroup Bounds",
          startDate: "2025-01-01",
        },
      ],
      suppliers: [
        {
          id: "supplier-bounds",
          name: "Supplier Bounds",
          channelType: "LETTER",
          dailyCapacity: "1000",
        },
      ],
      allocations: [
        {
          id: "allocation-high",
          volumeGroupId: "volume-group-bounds",
          supplier: "supplier-bounds",
          allocationPercentage: "150",
          status: "PUBLISHED",
        },
      ],
      supplierPacks: [],
    });
    const fileHigh = writeWorkbook(wbHigh);
    expect(() => parseExcelFile(fileHigh)).toThrow(
      /Validation failed.*allocation-high/,
    );

    const wbLow = buildWorkbook({
      packs: [
        {
          id: "pack-bounds2",
          name: "Pack Bounds 2",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-bounds2",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [
        {
          id: "volume-group-bounds2",
          name: "VolumeGroup Bounds 2",
          startDate: "2025-01-01",
        },
      ],
      suppliers: [
        {
          id: "supplier-bounds2",
          name: "Supplier Bounds 2",
          channelType: "LETTER",
          dailyCapacity: "1000",
        },
      ],
      allocations: [
        {
          id: "allocation-low",
          volumeGroupId: "volume-group-bounds2",
          supplier: "supplier-bounds2",
          allocationPercentage: "-5",
          status: "PUBLISHED",
        },
      ],
      supplierPacks: [],
    });
    const fileLow = writeWorkbook(wbLow);
    expect(() => parseExcelFile(fileLow)).toThrow(
      /Validation failed.*allocation-low/,
    );
  });

  it("parses SupplierPack rows for all statuses", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-sp",
          name: "Pack SP",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-sp",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [],
      suppliers: [
        { id: "supplier-sp", name: "Supplier SP", channelType: "LETTER", dailyCapacity: "1000" },
      ],
      allocations: [],
      supplierPacks: [
        {
          id: "sp-submitted",
          packSpecificationId: "pack-sp",
          supplierId: "supplier-sp",
          status: "SUBMITTED",
        },
        {
          id: "sp-approved",
          packSpecificationId: "pack-sp",
          supplierId: "supplier-sp",
          status: "APPROVED",
        },
        {
          id: "sp-rejected",
          packSpecificationId: "pack-sp",
          supplierId: "supplier-sp",
          status: "REJECTED",
        },
        {
          id: "sp-disabled",
          packSpecificationId: "pack-sp",
          supplierId: "supplier-sp",
          status: "DISABLED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.supplierPacks.spsubmitted.status).toBe("SUBMITTED");
    expect(result.supplierPacks.spapproved.status).toBe("APPROVED");
    expect(result.supplierPacks.sprejected.status).toBe("REJECTED");
    expect(result.supplierPacks.spdisabled.status).toBe("DISABLED");
  });

  it("throws on invalid SupplierPack status", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-sp-bad",
          name: "Pack SP Bad",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-sp-bad",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [],
      suppliers: [
        {
          id: "supplier-sp-bad",
          name: "Supplier SP Bad",
          channelType: "LETTER",
          dailyCapacity: "1000",
        },
      ],
      allocations: [],
      supplierPacks: [
        {
          id: "sp-invalid",
          packSpecificationId: "pack-sp-bad",
          supplierId: "supplier-sp-bad",
          status: "UNKNOWNSTATUS",
        },
      ],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(/Validation failed.*sp-invalid/);
  });

  it("leaves constraints undefined when none provided", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-no-constraints",
          name: "Pack No Constraints",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-nc",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-no-constraints",
          name: "Variant No Constraints",
          volumeGroupId: "volume-group-nc",
          packSpecificationIds: "pack-no-constraints",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
      volumeGroups: [
        { id: "volume-group-nc", name: "VolumeGroup NC", startDate: "2025-01-01" },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.packs.packnoconstraints.constraints).toBeUndefined();
    expect(result.variants.variantnoconstraints.constraints).toBeUndefined();
  });

  it("trims spaces in campaignIds and packSpecificationIds", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-space-1",
          name: "Pack Space 1",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-space-1",
          "postage.size": "STANDARD",
        },
        {
          id: "pack-space-2",
          name: "Pack Space 2",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-space-2",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-space",
          name: "Variant Space",
          volumeGroupId: "volume-group-space",
          packSpecificationIds: " pack-space-1 , pack-space-2 ",
          type: "STANDARD",
          status: "PUBLISHED",
          campaignIds: " campaign-1 ,  campaign-2 ",
        },
      ],
      volumeGroups: [
        {
          id: "volume-group-space",
          name: "VolumeGroup Space",
          startDate: "2025-01-01",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.variants.variantspace.packSpecificationIds).toEqual([
      "pack-space-1",
      "pack-space-2",
    ]);
    expect(result.variants.variantspace.campaignIds).toEqual([
      "campaign-1",
      "campaign-2",
    ]);
  });

  it("parses volume group and supplier IDs with special chars sanitizing keys", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-sanitize",
          name: "Pack Sanitize",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-sanitize",
          "postage.size": "STANDARD",
        },
      ],
      variants: [],
      volumeGroups: [
        {
          id: "volume-group#sanitize",
          name: "VolumeGroup Sanitize",
          startDate: "2025-01-01",
        },
      ],
      suppliers: [
        {
          id: "supplier@sanitize",
          name: "Supplier Sanitize",
          channelType: "LETTER",
          dailyCapacity: "1000",
        },
      ],
      allocations: [],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.volumeGroups.volumegroupsanitize.name).toBe("VolumeGroup Sanitize");
    expect(result.suppliers.suppliersanitize.name).toBe("Supplier Sanitize");
  });

  it("throws validation error for VolumeGroup with missing name", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-volume-group-bad",
          name: "Pack VolumeGroup Bad",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-volume-group-bad",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-volume-group-bad",
          name: "Variant VolumeGroup Bad",
          volumeGroupId: "volume-group-bad",
          packSpecificationIds: "pack-volume-group-bad",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
      // VolumeGroup row intentionally missing 'name' field to trigger validation error
      volumeGroups: [
        {
          id: "volume-group-bad",
          startDate: "2025-01-01",
        },
      ],
      suppliers: [],
      allocations: [],
      supplierPacks: [],
    });
    const file = writeWorkbook(wb);
    expect(() => parseExcelFile(file)).toThrow(
      /Validation failed.*volume-group-bad/,
    );
  });

  it("defaults volume group startDate when missing or invalid", () => {
    const wb = buildWorkbook({
      packs: [
        {
          id: "pack-default-date",
          name: "Pack Default Date",
          status: "PUBLISHED",
          version: "1",
          createdAt: "2025-01-01",
          updatedAt: "2025-01-01",
          "postage.id": "postage-default-date",
          "postage.size": "STANDARD",
        },
      ],
      variants: [
        {
          id: "variant-default-date",
          name: "Variant Default Date",
          volumeGroupId: "volume-group-missing-date",
          packSpecificationIds: "pack-default-date",
          type: "STANDARD",
          status: "PUBLISHED",
        },
        {
          id: "variant-invalid-date",
          name: "Variant Invalid Date",
          volumeGroupId: "volume-group-invalid-date",
          packSpecificationIds: "pack-default-date",
          type: "STANDARD",
          status: "PUBLISHED",
        },
      ],
      volumeGroups: [
        // Missing startDate entirely (will default)
        {
          id: "volume-group-missing-date",
          name: "VolumeGroup Missing Date",
          // no startDate provided
          status: "PUBLISHED",
        },
        // Invalid startDate string (will default)
        {
          id: "volume-group-invalid-date",
          name: "VolumeGroup Invalid Date",
          startDate: "not-a-valid-date",
          status: "PUBLISHED",
        },
      ],
    });
    const file = writeWorkbook(wb);
    const result = parseExcelFile(file);
    expect(result.volumeGroups.volumegroupmissingdate.startDate).toBe("2023-01-01");
    expect(result.volumeGroups.volumegroupinvaliddate.startDate).toBe("2023-01-01");
  });
});
